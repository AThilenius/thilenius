#!/bin/bash
. $HOME/thilenius/core/shell/base

DEFINE_boolean run false 'Run the executable after a successful build' r
DEFINE_boolean tests false 'Run tests after a successful build' t
DEFINE_boolean test_all false 'Build and run all tests under /thilenius' a
DEFINE_boolean clean false 'Clean the bin and gen dirs before building' c
DEFINE_boolean clean_all false 'Removes all bin and gen files before building' d
DEFINE_boolean verbose false 'Use verbose output' v
DEFINE_boolean package false 'Gathers dependencies and stores them in /package' p
DEFINE_boolean release false 'Build for release' e

FLAGS "$@" || exit $?
eval set -- "${FLAGS_ARGV}"

# Check for CMakeLists.txt
if [ ! -e "CMakeLists.txt"  ]; then
  EROR 'Failed to find CMakeLists.txt'
fi

# Compute relative path
PWD=$(pwd)
if [[ $PWD != $HOME/thilenius*  ]]; then
  EROR 'You must be inside $HOME/thilenius to use build'
fi

RPATH=${PWD#$HOME/thilenius/}
RPATH=${RPATH#$HOME/thilenius}
PWDD=${PWD##*/}

if [ ${FLAGS_verbose} -eq ${FLAGS_TRUE} ]; then
  INFO "    name: $PWDD"
  INFO "bin path: $HOME/thilenius_bin/$RPATH"
  INFO "gen path: $HOME/thilenius_gen/$RPATH"
fi

# Clean
if [ ${FLAGS_clean} -eq ${FLAGS_TRUE} ]; then
  INFO "Deleteing: $HOME/thilenius_bin/$RPATH"
  INFO "           $HOME/thilenius_gen/$RPATH"
  rm -rf $HOME/thilenius_bin/$RPATH
  rm -rf $HOME/thilenius_gen/$RPATH
fi

# Clean All
if [ ${FLAGS_clean_all} -eq ${FLAGS_TRUE} ]; then
  INFO "Deleteing: $HOME/thilenius_bin"
  INFO "           $HOME/thilenius_gen"
  rm -rf $HOME/thilenius_bin
  rm -rf $HOME/thilenius_gen
fi

# Build
INFO 'Running CMake'
if [ ${FLAGS_release} -eq ${FLAGS_TRUE} ]; then
  cmake -DCMAKE_BUILD_TYPE=Release -H. -B$HOME/thilenius_bin/$RPATH \
    || EROR 'CMake command failed.'
else
  cmake -H. -B$HOME/thilenius_bin/$RPATH || EROR 'CMake command failed.'
fi

INFO 'Running Make'
cd $HOME/thilenius_bin/$RPATH
make || EROR 'Make command failed.'
INFO 'Building completed successfully.'

# Run
if [ ${FLAGS_run} -eq ${FLAGS_TRUE} ]; then
  if [ ! -e "$HOME/thilenius_bin/$RPATH/$PWDD" ]; then
    WARN "No executable found at $HOME/thilenius_bin/$RPATH/$PWDD"
  else
    INFO "Running executable $HOME/thilenius_bin/$RPATH/$PWDD ${@:1}"
    pushd $HOME/thilenius/$RPATH
    $HOME/thilenius_bin/$RPATH/$PWDD ${@:1}
    popd
  fi
fi

# Test
if [ ${FLAGS_tests} -eq ${FLAGS_TRUE} ]; then
  if [ ! -e "$HOME/thilenius_bin/$RPATH/${PWDD}_test" ]; then
    WARN "No tests found at $HOME/thilenius_bin/$RPATH/${PWDD}_test"
  else
    INFO "Running tests at $HOME/thilenius_bin/$RPATH/${PWDD}_test"
    $HOME/thilenius_bin/$RPATH/${PWDD}_test || exit 1
  fi
fi

# Test All
if [ ${FLAGS_test_all} -eq ${FLAGS_TRUE} ]; then
  find $HOME/thilenius -name "CMakeLists.txt" -print0 | while IFS= read -r \
      -d $'\0' line; do
    TARGET_DIR=${line%/CMakeLists.txt}
    INFO "Found CMake target at $TARGET_DIR"
    pushd $TARGET_DIR
    build -t || exit 1
    popd
  done
  INFO 'All tests passing.'
fi

# Package
if [ ${FLAGS_package} -eq ${FLAGS_TRUE} ]; then
  mkdir -p $HOME/thilenius_bin/$RPATH/${PWDD}_package
  INFO "Collecting the shared library dependencies for $PWDD"
  deps=$(ldd $HOME/thilenius_bin/$RPATH/$PWDD | awk 'BEGIN{ORS=" "}$1\
  $HOME/^\//{print $1}$3$HOME/^\//{print $3}' | sed 's/,$/\n/')
  INFO "Copying dependencies to $HOME/thilenius_bin/$RPATH/${PWDD}_package"
  for dep in $deps; do
      INFO " - $dep"
      cp "$dep" "$HOME/thilenius_bin/$RPATH/${PWDD}_package/"
  done
  INFO "Copying ${PWDD} binary"
  cp "$HOME/thilenius_bin/${RPATH}/${PWDD}" \
      "$HOME/thilenius_bin/$RPATH/${PWDD}_package/"
fi
